<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>亞德醫材｜數位保固卡查詢</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --brand:#70B24D; --ink:#212121; --muted:#6b7280;
  --bg:#f7f8f9; --card:#fff; --shadow:0 6px 14px rgba(0,0,0,.04);
  --error-bg:#fef2f2; --error-border:#f5c2c2; --error-text:#8a1f1f;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,"PingFang TC",Arial,sans-serif}

/* Header */
.header{background:#fff;border-bottom:5px solid var(--brand)}
.nav{max-width:1080px;margin:0 auto;display:flex;align-items:center;gap:8px;padding:8px 10px}
.nav img{height:38px;width:auto}
.nav .title{font-weight:700;color:var(--brand)}

/* Layout */
.wrap{max-width:1080px;margin:0 auto;padding:8px}
.panel{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:8px;margin:4px 0}

/* Form */
.row{display:flex;flex-direction:column;gap:4px}
.field label{display:block;font-size:13px;color:var(--muted);margin:0 0 2px 6px}
.input{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;background:#fff;line-height:1}
.btn{width:100%;padding:12px 14px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-size:16px;font-weight:800;letter-spacing:.5px;cursor:pointer;margin-top:6px}
.btn:active{transform:translateY(1px)}

/* Result */
.grid{display:grid;grid-template-columns:1fr;gap:8px}
.card{display:grid;grid-template-columns:68px 1fr;gap:8px;align-items:center;background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:8px}
.product-thumb{width:68px;height:68px;border-radius:8px;border:1px solid #eee;object-fit:cover;background:#fafafa}
.kv{display:flex;gap:6px;flex-wrap:wrap;margin:0 0 2px}
.badge{display:inline-flex;align-items:center;font-size:12px;font-weight:700;padding:2px 8px;border-radius:999px}
.badge.ok{background:#eaf7ea;color:#1c5d19;border:1px solid #c9e6c7}
.badge.soon{background:#fff6e6;color:#8a5300;border:1px solid #ffe0a6}
.badge.expired{background:#fcebec;color:#8a1f1f;border:1px solid #f5c2c2}
.meta{font-size:14px;line-height:1.5;margin:1px 0}
.meta b{color:#111}
.codepill{background:#eef2f7;border:1px solid #e3e8ef;color:#3b4a5a;border-radius:10px;padding:4px 8px;font-weight:800}

/* Expand */
.toggle{margin-top:6px;background:none;border:none;color:var(--brand);font-size:14px;font-weight:700;cursor:pointer;padding:0;display:inline-flex;align-items:center;gap:4px}
.toggle .arrow{transition:transform .2s ease}
.card.open .toggle .arrow{transform:rotate(180deg)}
.details{display:none;border-top:1px dashed #e5e7eb;margin-top:4px;padding-top:6px;color:#444;line-height:1.5;font-size:13px;white-space:pre-wrap}
.card.open .details{display:block}

/* Error */
.alert{background:var(--error-bg);border:1px solid var(--error-border);color:var(--error-text);padding:10px 14px;border-radius:10px;font-size:14px;font-weight:600;text-align:center}

/* Desktop */
@media (min-width:768px){
  .row{flex-direction:row;align-items:flex-end;gap:10px}
  .btn{width:auto}
  .wrap{padding:14px}
  .panel{padding:10px;margin:8px 0}
  .grid{gap:10px}
  .card{grid-template-columns:88px 1fr;padding:10px}
  .product-thumb{width:88px;height:88px}
}
</style>
</head>
<body>
<header class="header">
  <div class="nav">
    <img src="https://raw.githubusercontent.com/uryard7737-sketch/LOGO/main/%E4%BA%9E%E5%BE%B7%E9%86%AB%E6%9D%90%201000x500-07.png" alt="亞德醫材 Logo">
    <div class="title">數位保固卡查詢</div>
  </div>
</header>

<main class="wrap">
  <section class="panel" aria-label="查詢條件">
    <div class="row">
      <div class="field" style="flex:1 1 220px">
        <label for="phone">手機後四碼</label>
        <input id="phone" class="input" maxlength="4" inputmode="numeric" placeholder="例如：1688" />
      </div>
      <div class="field" style="flex:1 1 220px">
        <label for="fullname">姓名（全名）</label>
        <input id="fullname" class="input" placeholder="例如：王小明" />
      </div>
      <button id="btn" class="btn">查詢</button>
    </div>
  </section>

  <div id="result" class="grid" aria-live="polite"></div>
</main>

<script>
/* Google Sheet CSV */
const CSV_PATH =
  "https://docs.google.com/spreadsheets/d/1KN0rAcwCFqLCUbQrVlEh8GdgiOlXa1nvA2oAq3Ex2Gk/gviz/tq?tqx=out:csv&sheet=產品保固紀錄";

let DATA = [];

function normalize4(v){
  if(!v) return "";
  const map = {"０":"0","１":"1","２":"2","３":"3","４":"4","５":"5","６":"6","７":"7","８":"8","９":"9"};
  return v.toString().trim().replace(/[０-９]/g,ch=>map[ch]).replace(/\D/g,"").slice(0,4);
}

function loadCSV(){
  return new Promise((resolve,reject)=>{
    Papa.parse(CSV_PATH,{
      download:true, header:true, skipEmptyLines:true,
      complete: res => resolve(res.data),
      error: err => reject(err)
    });
  });
}

function statusBadge(until){
  const exp=new Date(until), now=new Date();
  const days=(exp-now)/86400000;
  if(isNaN(exp.getTime())) return ["—","ok"];
  if(exp<now) return ["已過保","expired"];
  if(days<=30) return ["即將到期","soon"];
  return ["保固內","ok"];
}

function render(list){
  const box=document.getElementById("result"); box.innerHTML="";
  if(!list.length){
    box.innerHTML=`
      <div class="alert">
        ❌ 查無符合的保固紀錄，請確認輸入是否正確或聯絡客服。<br><br>
        <button id="retryBtn" class="btn" style="width:auto;padding:6px 12px;font-size:14px;margin-top:6px">
          🔄 重新查詢
        </button>
      </div>`;
    document.getElementById("retryBtn").addEventListener("click",()=>{
      document.getElementById("phone").value="";
      document.getElementById("fullname").value="";
      document.getElementById("phone").focus();
      box.innerHTML="";
    });
    return;
  }
  list.forEach(r=>{
    const [label,cls]=statusBadge(r.WarrantyUntil);
    const detailsText = (r.WarrantyText||"").trim() || "本產品保固條款請依原廠為準。";
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <img class="product-thumb" src="${r.ImageURL||'https://dummyimage.com/200x200/eeeeee/000000&text=Product'}" alt="product">
      <div>
        <div class="kv"><span class="codepill">${r.Model||""}</span><span class="badge ${cls}">${label}</span></div>
        <div class="meta"><b>${r.Brand||""} ${r.ProductName||""}</b></div>
        <div class="meta">保固到期：<b>${r.WarrantyUntil||"-"}</b> ｜ 購買日期：${r.PurchaseDate||"-"}</div>
        <div class="meta">姓名：${r.FullName||"-"} ｜ 手機：${r.Phone||"-"}</div>
        <button class="toggle" type="button"><span class="arrow">⌄</span> 保固內容說明</button>
        <div class="details">${detailsText}</div>
        <div class="meta">門市：${r.Shop||"-"}</div>
        <div class="meta">備註：${r.Notes||"-"} ｜ 紀錄ID：${r.RecordID||"-"}</div>
      </div>`;
    box.appendChild(card);
  });
  document.querySelectorAll(".toggle").forEach(btn=>{
    btn.addEventListener("click",()=>{ btn.closest(".card").classList.toggle("open"); });
  });
}

document.getElementById("btn").addEventListener("click",()=>{
  const p = normalize4(document.getElementById("phone").value);
  const name = document.getElementById("fullname").value.trim();
  if(p.length!==4 || !name){ render([]); return; }
  const key = p + name;
  const res = DATA.filter(r => String(r.LookupKey||"") === key);
  render(res);
});

loadCSV().then(rows=>{ DATA = rows; }).catch(err=>{
  console.error("CSV 讀取失敗", err);
  document.getElementById("result").innerHTML =
    '<div class="alert">⚠️ 資料載入失敗，請確認試算表分享設定與分頁名稱。</div>';
});
</script>
</body>
</html>
